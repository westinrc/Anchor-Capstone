from flask import Flask, request, Response, jsonify
from utils.random_patient_generation import generate
from utils.settings_update import update_settings
from utils.data_storage import upload_pitt_data
from utils.data_storage import load_icd9_structure
from utils.data_storage import build_structured_rep
from utils.preprocess_patients import preprocess
import sys
import json
import pymysql

app = Flask('anchor_explorer')
#redis = Redis(host='redis', port=6379)

@app.route('/example', methods=['GET'])
def example():
    return "Hello this is an example"

@app.route('/generate-random-patients', methods=['POST'])
def generate_random_patients():
    request_json = request.get_json(force=True)
    number_patients = request_json['number_patients']
    patients_xml = generate(number_patients)
    return Response(patients_xml, mimetype='text/xml')

@app.route('/update-settings', methods=['PUT'])
def settings_update():
    settings = request.data
    settings = update_settings(str(settings))
    return settings

@app.route('/upload-pitt-delimited', methods=['POST'])
def fill_database():
    pitt_file = request.files.get('pitt-delimited')
    result = upload_pitt_data(pitt_file)
    return result

@app.route('/load-icd9-structure', methods=['POST'])
def load_icd9_struct():
    load_icd9_structure()
    return "Success"

@app.route('/build-structured-rep', methods=['POST'])
def build_rep():
    request_json = request.get_json(force=True)
    data_type = request_json['datatype']
    build_structured_rep(data_type)
    return "Success"

@app.route('/preprocess-patients', methods=['POST'])
def preprocess_patients():
    request_json = request.get_json(force=True)
    max_patients = request_json['max_patients']
    fix_vocab = request_json['fix_vocab']
    result = preprocess(max_patients, fix_vocab)
    return str(result)

@app.route('/endpoint-for-patients', methods=['GET'])
def send_demo_patients():
    patients = {
        'patient_index_1' : {
            'name' : 'John Doe',
            'sex' : '?',
            'age' : '?',
            'diagnosis' : '584.9 486 008.45 599.0 276.51 263.9 458.9 414.00 401.9 272.4 280.9 311 427.61 438.20 787.2 733.6 787.01 412 V44.3 V45.81 V10.06 V64.06',
            'diagnosis_parsed' : [{'disp': 'Acute renal failure, unspecified', 'repr': 'code_584.9'},
                        {'disp': 'Pneumonia, organism unspecified', 'repr': 'code_486'},
                        {'disp': 'Clostridium difficile', 'repr': 'code_008.45'},
                        {'disp': 'Urinary tract infection, site not specified', 'repr': 'code_599.0'},
                        {'disp': 'Dehydration', 'repr': 'code_276.51'},
                        {'disp': 'Unspecified protein-calorie malnutrition', 'repr': 'code_263.9'},
                        {'disp': 'Hypotension, unspecified', 'repr': 'code_458.9'},
                        {'disp': 'Of unspecified type of vessel, native or graft', 'repr': 'code_414.00'},
                        {'disp': 'Unspecified', 'repr': 'code_401.9'},
                        {'disp': 'Other and unspecified hyperlipidemia', 'repr': 'code_272.4'},
                        {'disp': 'code_280.9', 'repr': 'code_280.9'},
                        {'disp': 'Depressive disorder, not elsewhere classified', 'repr': 'code_311'},
                        {'disp': 'Supraventricular premature beats', 'repr': 'code_427.61'},
                        {'disp': 'Hemiplegia affecting unspecified side', 'repr': 'code_438.20'},
                        {'disp': 'Dysphagia', 'repr': 'code_787.2'},
                        {'disp': "Tietze's disease", 'repr': 'code_733.6'},
                        {'disp': 'Nausea with vomiting', 'repr': 'code_787.01'},
                        {'disp': 'Old myocardial infarction', 'repr': 'code_412'},
                        {'disp': 'Colostomy', 'repr': 'code_V44.3'},
                        {'disp': 'Aortocoronary bypass status', 'repr': 'code_V45.81'},
                        {'disp': 'Rectum, rectosigmoid junction, and anus', 'repr': 'code_V10.06'},
                        {'disp': 'Vaccination not carried out because of patient refusal', 'repr': 'code_V64.06'}],
            'text' : '[|report|de|-|identified|(|safe|-|harbor|compliant|)|by|de|-|id|v|.|6|.|22|.|07|.|0|]|*|*|institution|history|&|physi cal|name|:|*|*|name|[|aaa|,|bbb|]|acct|#|:|*|*|id|-|num|mrn|:|*|*|id|-|num|admitted|:|*|*|date|[|nov|01|2007|]|dict|:|*|*|name|[|xxx|,|www|]|attend|:|,|reason|for|admission|:|c|.|difficile|colitis|.|history|of|present|illness|:|mr|.|*|*|name|[|aaa|]|is|an|*|*|age|[|in|80s|]|-|year|-|old|gentleman|with|a|recently|complicated|past|medical|history|.|he|has|a|past|history|of|coronary|artery|disease|status|post|cabg|in|2001|.|he|has|hypertension|and|he|has|a|history|of|colorectal|cancer|for|which|he|underwent|surgery|and|has|a|colostomy|in|place|.|this|was|done|15|years|ago|.|in|late|*|*|date|[|sep|]|the|patient|sustained|a|left|-|sided|clavicular|fracture|and|shoulder|injury|.|for|this|he|was|admitted|at|*|*|institution|.|he|was|being|managed|there|and|subsequently|was|transferred|to|*|*|institution|fro|sepsis|.|he|was|admitted|at|the|icu|at|*|*|institution|where|he|was|managed|for|his|sepsis|.|blood|cultures|from|the|outside|hospital|showed|e|.|coli|.|the|patient|was|managed|with|iv|antibiotics|.|during|his|stay|in|the|icu|he|developed|a|left|-|sided|parietal|infarction|.|infective|endocarditis|was|ruled|out|on|a|transthoracic|echocardiogram|.|the|patient|was|treated|with|aggrenox|.|also|,|during|this|time|period|the|patient|had|shortness|of|breath|and|a|cough|productive|of|frothy|white|sputum|.|his|sputum|cultures|grew|(|_______________|)|.|this|was|thought|to|be|a|contamination|and|a|ct|scan|of|the|chest|showed|multilobar|pneumonia|.|the|patient|was|treated|with|iv|zosyn|.|he|was|kept|on|1|liter|of|oxygen|by|nasal|cannula|,|flutter|valve|treatment|,|physical|therapy|,|duonebs|,|and|expectorant|treatment|was|given|.|also|,|during|the|hospital|stay|the|patient|was|markedly|depressed|and|was|kept|on|zoloft|.|the|patient|was|transferred|on|*|*|date|[|oct|9|2007|]|,|to|*|*|institution|rehabilitation|at|*|*|place|where|his|antibiotics|for|2|weeks|for|a|completion|of|a|2|-|weeks\'|course|were|continued|.|about|a|week|ago|the|patient|was|transferred|to|*|*|name|[|vvv|]|again|with|productive|cough|of|frothy|sputum|and|shortness|of|breath|.|over|there|,|dr|.|(|_______________|)|did|a|bronchoscopy|.|according|to|his|note|,|there|was|no|endobronchial|lesion|in|the|right|upper|lobe|.|in|the|post|bronchoscopy|sputum|and|washings|the|patient|grew|fungus|.|by|this|time|on|evaluating|his|imaging|,|he|mentions|in|his|note|that|originally|there|was|a|right|lower|lobe|,|right|upper|lobe|,|and|left|lower|lobe|infiltrate|which|are|resolving|.|the|right|upper|lobe|infiltrate|,|however|,|is|still|persistent|.|the|patient|was|discharged|back|to|southside|rehabilitation|on|iv|diflucan|,|starting|on|*|*|date|[|oct|27|2007|]|.|at|southside|rehabilitation|the|patient|continued|to|have|his|productive|cough|and|yesterday|iv|zosyn|was|added|by|the|patient\'s|pcp|.|he|also|added|flagyl|500|mg|p|.|o|.|t|.|i|.|d|.|to|cover|for|c|.|difficile|colitis|.|yesterday|,|the|patient|had|a|sudden|increase|in|colostomy|output|.|during|1|shift|he|had|1700|cc|put|out|.|also|,|he|was|noted|to|have|a|fever|.|his|white|cell|count|yesterday|had|jumped|up|to|24|,|000|.|on|*|*|date|[|oct|28|2007|]|,|it|was|7|.|9|.|neutrophil|count|was|72%|and|bandemia|was|23%|.|a|sepsis|workup|was|done|and|the|patient|was|positive|for|c|.|difficile|colitis|.|also|,|his|ua|was|consistent|with|a|uti|.|today|,|the|patient|was|noted|to|have|a|blood|pressure|of|80|to|90|systolic|,|was|tachycardic|,|and|was|noted|to|have|pacs|.|for|this|reason|the|patient|was|transferred|to|*|*|institution|for|further|management|.|past|medical|history|:|the|patient|had|an|mi|in|1991|.|in|2001|he|had|a|4|-|vessel|cabg|.|he|has|hypertension|.|fifteen|years|ago|he|was|diagnosed|with|rectal|cancer|.|he|underwent|a|surgery|and|sustained|a|colostomy|from|that|surgery|.|since|then|he|has|not|had|any|chemotherapy|or|radiation|therapy|.|he|is|not|being|followed|up|by|any|oncologist|and|neither|does|he|have|a|cardiologist|.|review|of|systems|:|as|per|his|history|of|present|illness|.|also|,|the|patient|has|anorexia|,|decreased|p|.|o|.|intake|,|and|nausea|.|he|has|been|vomiting|.|he|has|intermittent|fevers|and|chills|.|his|fevers|are|up|to|101|.|he|complains|of|shortness|of|breath|on|exertion|;|however|,|these|days|he|is|not|exerting|himself|too|much|.|as|mentioned|above|,|he|has|a|cough|productive|of|foamy|white|sputum|.|he|has|had|significant|weight|loss|;|however|,|he|does|not|know|how|much|.|he|does|complain|of|intermittent|urinary|incontinence|.|medications|:|1|.|aggrenox|25|/|200|mg|tablet|1|tablet|b|.|i|.|d|.|2|.|lomotil|1|tablet|q|.|6|h|.|3|.|diflucan|100|mg|iv|q|.|12|.|4|.|humibid|2|tablets|p|.|o|.|b|.|i|.|d|.|5|.|subcu|heparin|.|6|.|ferrex|150|mg|p|.|o|.|b|.|i|.|d|.|7|.|megace|40|mg|p|.|o|.|b|.|i|.|d|.|8|.|metronidazole|which|was|started|yesterday|,|500|mg|p|.|o|.|t|.|i|.|d|.|9|.|multivitamins|.|10|.|nystatin|local|application|.|11|.|protonix|40|mg|p|.|o|.|daily|.|12|.|zosyn|4|.|5|mg|iv|q|.|8|h|.|which|was|started|yesterday|.|13|.|probenecid|500|mg|p|.|o|.|b|.|i|.|d|.|14|.|triamcinolone|local|application|b|.|i|.|d|.|15|.|effexor|37|.|5|mg|p|.|o|.|daily|.|16|.|verapamil|90|mg|p|.|o|.|daily|.|17|.|flagyl|was|entered|twice|500|mg|q|.|6|h|.|iv|.|18|.|tylenol|.|19|.|zofran|.|20|.|percocet|.|21|.|benazepril|20|mg|p|.|o|.|daily|.|allergies|:|the|patient|has|no|known|drug|allergies|.|family|history|:|noncontributory|.|social|history|:|the|patient|used|to|live|alone|up|until|*|*|date|[|sep|]|.|prior|to|that|,|especially|in|the|summers|,|he|did|extensive|gardening|work|.|he|is|a|retired|coal|miner|.|he|has|a|remote|history|of|tobacco|use|.|he|stopped|about|50|years|ago|and|has|an|approximate|10|-|year|-|pack|history|.|he|has|occasional|ethanol|intake|.|he|denies|iv|drug|use|.|physical|examination|:|this|is|an|elderly|gentleman|.|he|looks|very|wasted|and|cachectic|.|he|is|alert|and|cooperative|.|blood|pressure|112|/|52|,|pulse|100|,|respiratory|rate|18|,|temperature|36|.|7|,|saturations|95|.|heent|:|the|patient|is|very|cachectic|and|he|has|temporal|wasting|.|otherwise|,|extraocular|muscles|are|intact|.|pupils|are|bilaterally|equally|reactive|to|light|.|he|has|moist|mucous|membranes|.|no|cervical|lymphadenopathy|.|there|is|no|jvp|.|cardiovascular|exam|:|there|is|a|central|sternotomy|scar|.|he|has|a|normal|s1|,|s2|with|a|systolic|murmur|.|he|is|slightly|tachycardic|.|pulmonary|exam|:|the|patient|has|coarse|crackles|,|right|more|than|the|left|side|.|the|crackles|are|in|the|lower|and|mid|zone|.|there|is|mid|and|upper|zone|bronchial|breathing|on|the|right|-|hand|side|.|on|the|left|side|there|are|coarse|crackles|,|particularly|at|the|bases|.|there|is|intermittent|wheezing|.|abdomen|is|soft|,|looks|slightly|distended|,|and|he|is|tender|diffusely|.|the|left|half|of|his|abdomen|-|he|has|a|colostomy|in|place|with|greenish|feces|.|gut|sounds|are|audible|but|reduced|.|lower|extremities|:|there|is|no|edema|.|the|patient|has|right|upper|and|lower|extremity|weakness|.|labs|:|all|labs|are|pending|at|this|point|in|time|.|assessment|and|plan|:|this|is|an|*|*|age|[|in|80s|]|-|year|-|old|gentleman|with|a|complicated|past|medical|history|since|the|past|2|months|or|so|.|he|presents|from|southside|rehabilitation|with|the|following|issues|.|1|.|clostridium|difficile|colitis|.|the|patient|has|been|started|on|flagyl|500|mg|p|.|o|.|t|.|i|.|d|.|his|zosyn|has|been|put|on|hold|.|we|are|also|starting|lactinex|1|pack|p|.|o|.|q|.|i|.|d|.|i|will|check|an|abdominal|x|-|ray|as|the|patient|is|complaining|of|abdominal|tenderness|.|this|is|to|rule|out|any|toxic|megacolon|or|perforation|.|2|.|multilobar|pneumonia|.|the|patient|has|already|received|zosyn|last|month|for|2|weeks|for|this|.|he|has|recently|been|started|on|diflucan|based|on|fungus|that|was|grown|in|his|bronchial|washings|.|i|do|not|have|the|details|available|of|the|bronchial|report|or|the|culture|at|this|point|in|time|.|we|will|continue|the|iv|diflucan|.|we|will|check|a|ct|scan|of|the|chest|without|contrast|.|we|will|consult|dr|.|*|*|name|[|uuu|]|\'s|group|.|we|will|also|continue|the|patient\'s|duoneb|,|mucomyst|,|and|guaifenesin|and|send|off|sputum|cultures|.|3|.|dehydration|and|prerenal|azotemia|.|reportedly|,|the|patient|has|had|a|bump|in|his|creatinine|.|a|couple|of|days|ago|,|his|creatinine|was|0|.|9|and|now|it|has|increased|to|3|at|the|rehabilitation|.|this|most|likely|seems|prerenal|because|of|the|dehydration|and|decreased|p|.|o|.|intake|as|well|as|vomiting|.|we|will|generously|hydrate|the|patient|.|the|patient|has|been|started|on|normal|saline|at|200|ml|per|hour|.|we|will|generously|hydrate|as|the|patient\'s|ejection|fraction|is|60%|.|he|does|have|a|history|of|diastolic|dysfunction|.|therefore|,|we|will|be|careful|not|to|cause|volume|overload|.|check|urine|electrolytes|but|we|will|hold|off|on|any|further|renal|workup|.|we|will|hold|any|nephrotoxic|medications|and|renally|adjust|his|medications|.|4|.|ectopic|beats|.|i|will|check|an|ekg|and|place|the|patient|on|a|monitor|.|5|.|deep|vein|thrombosis|prophylaxis|,|gastrointestinal|prophylaxis|,|pt|,|and|ot|consult|.|we|will|consult|social|work|.|the|patient|has|been|discussed|with|the|attending|.|______________________________|*|*|name|[|www|xxx|]|,|resident|hs|job|\#|432079|/|36382|/|shy|#|*|*|id|-|num|d|:|*|*|date|[|nov|01|2007|]|20|:|17|t|:|*|*|date|[|nov|01|2007|]|20|:|40|*|*|carbon|-|copy',
            'note' : '[Report de-identified (Safe-harbor compliant) by De-ID v.6.22.07.0]\\n\\n\\n**INSTITUTION\\nHistory & Physical\\nName: **NAME[AAA, BBB]\\nAcct #: **ID-NUM\\nMRN: **ID-NUM\\nAdmitted: **DATE[Nov 01 2007]\\nDict: **NAME[XXX, WWW]\\nAttend: , \\nREASON FOR ADMISSION:  C. difficile colitis.\\nHISTORY OF PRESENT ILLNESS:  Mr. **NAME[AAA] is an **AGE[in 80s]-year-old gentleman with a \\nrecently complicated past medical history.  He has a past history of coronary \\nartery disease status post CABG in 2001.  He has hypertension and he has a \\nhistory of colorectal cancer for which he underwent surgery and has a \\ncolostomy in place.  This was done 15 years ago.  In late **DATE[Sep] the \\npatient sustained a left-sided clavicular fracture and shoulder injury.  For \\nthis he was admitted at **INSTITUTION.  He was being managed there and \\nsubsequently was transferred to **INSTITUTION fro sepsis.  He was \\nadmitted at the ICU at **INSTITUTION where he was managed for his \\nsepsis.  Blood cultures from the outside hospital showed E. coli.  The \\npatient was managed with IV antibiotics.  During his stay in the ICU he \\ndeveloped a left-sided parietal infarction.  Infective endocarditis was ruled \\nout on a transthoracic echocardiogram.  The patient was treated with \\nAggrenox.  Also, during this time period the patient had shortness of breath \\nand a cough productive of frothy white sputum.  His sputum cultures grew \\n(_______________).  This was thought to be a contamination and a CT scan of \\nthe chest showed multilobar pneumonia.  The patient was treated with IV \\nZosyn.  He was kept on 1 liter of oxygen by nasal cannula, flutter valve \\ntreatment, physical therapy, DuoNebs, and expectorant treatment was given.  \\nAlso, during the hospital stay the patient was markedly depressed and was \\nkept on Zoloft.  The patient was transferred on **DATE[Oct 9 2007], to \\n**INSTITUTION Rehabilitation at **PLACE where his antibiotics for 2 weeks \\nfor a completion of a 2-weeks\'  course were continued.  About a week ago the \\npatient was transferred to **NAME[VVV] again with productive cough of frothy \\nsputum and shortness of breath.  Over there, Dr. (_______________) did a \\nbronchoscopy.  According to his note, there was no endobronchial lesion in \\nthe right upper lobe.  In the post bronchoscopy sputum and washings the \\npatient grew fungus.  By this time on evaluating his imaging, he mentions in \\nhis note that originally there was a right lower lobe, right upper lobe, and \\nleft lower lobe infiltrate which are resolving.  The right upper lobe \\ninfiltrate, however, is still persistent.  The patient was discharged back to \\nSouthside Rehabilitation on IV Diflucan, starting on **DATE[Oct 27 2007].  At \\nSouthside Rehabilitation the patient continued to have his productive cough \\nand yesterday IV Zosyn was added by the patient\'s PCP.  He also added Flagyl \\n500 mg p.o. t.i.d. to cover for C. difficile colitis.  Yesterday, the patient \\nhad a sudden increase in colostomy output.  During 1 shift he had 1700 cc put \\nout.  Also, he was noted to have a fever.  His white cell count yesterday had \\njumped up to 24,000.  On **DATE[Oct 28 2007], it was 7.9.  Neutrophil count was \\n72% and bandemia was 23%.  A sepsis workup was done and the patient was \\npositive for C. difficile colitis.  Also, his UA was consistent with a UTI.  \\nToday, the patient was noted to have a blood pressure of 80 to 90 systolic, \\nwas tachycardic, and was noted to have PACs.  For this reason the patient was \\ntransferred to **INSTITUTION for further management.\\nPAST MEDICAL HISTORY:  The patient had an MI in 1991.  In 2001 he had a \\n4-vessel CABG.  He has hypertension.  Fifteen years ago he was diagnosed with \\nrectal cancer.  He underwent a surgery and sustained a colostomy from that \\nsurgery.  Since then he has not had any chemotherapy or radiation therapy.  \\nHe is not being followed up by any oncologist and neither does he have a \\ncardiologist.\\nREVIEW OF SYSTEMS:  As per his history of present illness.  Also, the patient \\nhas anorexia, decreased p.o. intake, and nausea.  He has been vomiting.  He \\nhas intermittent fevers and chills.  His fevers are up to 101.  He complains \\nof shortness of breath on exertion; however, these days he is not exerting \\nhimself too much.  As mentioned above, he has a cough productive of foamy \\nwhite sputum.  He has had significant weight loss; however, he does not know \\nhow much.  He does complain of intermittent urinary incontinence.\\nMEDICATIONS:  \\n1.  Aggrenox 25/200 mg tablet 1 tablet b.i.d.\\n2.  Lomotil 1 tablet q.6 h.\\n3.  Diflucan 100 mg IV q.12 .\\n4.  Humibid 2 tablets p.o. b.i.d.\\n5.  Subcu heparin.\\n6.  Ferrex 150 mg p.o. b.i.d.\\n7.  Megace 40 mg p.o. b.i.d.\\n8.  Metronidazole which was started yesterday, 500 mg p.o. t.i.d.\\n9.  Multivitamins.\\n10.  Nystatin local application.\\n11.  Protonix 40 mg p.o. daily.\\n12.  Zosyn 4.5 mg IV q.8 h. which was started yesterday.\\n13.  Probenecid 500 mg p.o. b.i.d.\\n14.  Triamcinolone local application b.i.d.\\n15.  Effexor 37.5 mg p.o. daily.\\n16.  Verapamil 90 mg p.o. daily.\\n17.  Flagyl was entered twice 500 mg q.6 h. IV.\\n18.  Tylenol.\\n19.  Zofran.\\n20.  Percocet.\\n21.  Benazepril 20 mg p.o. daily.\\nALLERGIES:  THE PATIENT HAS NO KNOWN DRUG ALLERGIES.\\nFAMILY HISTORY:  Noncontributory.\\nSOCIAL HISTORY:  The patient used to live alone up until **DATE[Sep].  Prior to \\nthat, especially in the summers, he did extensive gardening work.  He is a \\nretired coal miner.  He has a remote history of tobacco use.  He stopped \\nabout 50 years ago and has an approximate 10-year-pack history.  He has \\noccasional ethanol intake.  He denies IV drug use.\\nPHYSICAL EXAMINATION:  This is an elderly gentleman.  He looks very wasted \\nand cachectic.  He is alert and cooperative.  Blood pressure 112/52, pulse \\n100, respiratory rate 18, temperature 36.7, saturations 95.  HEENT:  The \\npatient is very cachectic and he has temporal wasting.  Otherwise, \\nextraocular muscles are intact.  Pupils are bilaterally equally reactive to \\nlight.  He has moist mucous membranes.  No cervical lymphadenopathy.  There \\nis no JVP.  Cardiovascular  Exam:  There is a central sternotomy scar.  He \\nhas a normal S1, S2 with a systolic murmur.  He is slightly tachycardic.  \\nPulmonary Exam:  The patient has coarse crackles, right more than the left \\nside.  The crackles are in the lower and mid zone.  There is mid and upper \\nzone bronchial breathing on the right-hand side.  On the left side there are \\ncoarse crackles, particularly at the bases.  There is intermittent wheezing.  \\nAbdomen is soft, looks slightly distended, and he is tender diffusely.  The \\nleft half of his abdomen - he has a colostomy in place with greenish feces.  \\nGut sounds are audible but reduced.  Lower Extremities:  There is no edema.  \\nThe patient has right upper and lower extremity weakness.\\nLABS:  All labs are pending at this point in time.\\nASSESSMENT AND PLAN:  This is an **AGE[in 80s]-year-old gentleman with a complicated \\npast medical history since the past 2 months or so.  He presents from \\nSouthside Rehabilitation with the following issues.\\n1.  Clostridium difficile colitis.  The patient has been started on Flagyl \\n500 mg p.o. t.i.d.  His Zosyn has been put on hold.  We are also starting \\nLactinex 1 pack p.o. q.i.d.  I will check an abdominal x-ray as the patient \\nis complaining of abdominal tenderness.  This is to rule out any toxic \\nmegacolon or perforation.\\n2.  Multilobar pneumonia.  The patient has already received Zosyn last month \\nfor 2 weeks for this.  He has recently been started on Diflucan based on \\nfungus that was grown in his bronchial washings.  I do not have the details \\navailable of the bronchial report or the culture at this point in time.  We \\nwill continue the IV Diflucan.  We will check a CT scan of the chest without \\ncontrast.  We will consult Dr. **NAME[UUU]\'s group.  We will also continue the \\npatient\'s DuoNeb, Mucomyst, and guaifenesin and send off sputum cultures.\\n3.  Dehydration and prerenal azotemia.  Reportedly, the patient has had a \\nbump in his creatinine.  A couple of days ago, his creatinine was 0.9 and now \\nit has increased to 3 at the rehabilitation.  This most likely seems prerenal \\nbecause of the dehydration and decreased p.o. intake as well as vomiting.  We \\nwill generously hydrate the patient.  The patient has been started on normal \\nsaline at 200 mL per hour.  We will generously hydrate as the patient\'s \\nejection fraction is 60%.  He does have a history of diastolic dysfunction.  \\nTherefore, we will be careful not to cause volume overload.  Check urine \\nelectrolytes but we will hold off on any further renal workup.  We will hold \\nany nephrotoxic medications and renally adjust his medications.\\n4.  Ectopic beats.  I will check an EKG and place the patient on a monitor.\\n5.  Deep vein thrombosis prophylaxis, gastrointestinal prophylaxis, PT, and \\nOT consult.  We will consult social work.\\nThe patient has been discussed with the attending.\\n______________________________\\n**NAME[WWW XXX], Resident\\nHS Job # 432079 / 36382 / \\nSHY # **ID-NUM\\nD: **DATE[Nov 01 2007] 20:17\\nT: **DATE[Nov 01 2007] 20:40\\n\\n**CARBON-COPY\\n\\n\\n\\n\n',
        },
        'patient_index_2' : {
            'name' : 'Jane Doe',
            'sex' : '?',
            'age' : '?',
            'diagnosis' : '584.9 486 008.45 599.0 276.51 263.9 458.9 414.00 401.9 272.4 280.9 311 427.61 438.20 787.2 733.6 787.01 412 V44.3 V45.81 V10.06 V64.06',
            'diagnosis_parsed' : [{'disp': 'Acute renal failure, unspecified', 'repr': 'code_584.9'},
                      {'disp': 'Pneumonia, organism unspecified', 'repr': 'code_486'},
                      {'disp': 'Clostridium difficile', 'repr': 'code_008.45'},
                      {'disp': 'Urinary tract infection, site not specified', 'repr': 'code_599.0'},
                      {'disp': 'Dehydration', 'repr': 'code_276.51'},
                      {'disp': 'Unspecified protein-calorie malnutrition', 'repr': 'code_263.9'},
                      {'disp': 'Hypotension, unspecified', 'repr': 'code_458.9'},
                      {'disp': 'Of unspecified type of vessel, native or graft', 'repr': 'code_414.00'},
                      {'disp': 'Unspecified', 'repr': 'code_401.9'},
                      {'disp': 'Other and unspecified hyperlipidemia', 'repr': 'code_272.4'},
                      {'disp': 'code_280.9', 'repr': 'code_280.9'},
                      {'disp': 'Depressive disorder, not elsewhere classified', 'repr': 'code_311'},
                      {'disp': 'Supraventricular premature beats', 'repr': 'code_427.61'},
                      {'disp': 'Hemiplegia affecting unspecified side', 'repr': 'code_438.20'},
                      {'disp': 'Dysphagia', 'repr': 'code_787.2'},
                      {'disp': "Tietze's disease", 'repr': 'code_733.6'},
                      {'disp': 'Nausea with vomiting', 'repr': 'code_787.01'},
                      {'disp': 'Old myocardial infarction', 'repr': 'code_412'},
                      {'disp': 'Colostomy', 'repr': 'code_V44.3'},
                      {'disp': 'Aortocoronary bypass status', 'repr': 'code_V45.81'},
                      {'disp': 'Rectum, rectosigmoid junction, and anus', 'repr': 'code_V10.06'},
                      {'disp': 'Vaccination not carried out because of patient refusal', 'repr': 'code_V64.06'}],
            'text' : '[|report|de|-|identified|(|safe|-|harbor|compliant|)|by|de|-|id|v|.|6|.|22|.|07|.|0|]|examination|performed|:|ct|thorax|without|contrast|*|*|date|[|nov|02|07|]|0944|hours|clinical|history|:|multilobar|pneumonia|.|evaluation|for|response|.|comparison|:|previous|chest|ct|scan|from|*|*|date|[|oct|04|2007|]|.|technique|:|helical|ct|imaging|of|the|chest|was|obtained|without|intravenous|or|oral|contrast|with|contiguous|5|.|0mm|thick|axial|reconstructions|using|both|lung|and|standard|reconstruction|algorithms|.|findings|:|the|areas|of|patchy|airspace|consolidation|in|the|left|upper|lobe|have|resolved|.|there|has|been|near|complete|resolution|of|the|left|lower|lobe|pneumonia|.|the|left|pleural|effusion|has|resolved|.|there|is|persistent|extensive|dense|consolidation|in|the|right|upper|lobe|which|has|decreased|.|the|areas|of|airspace|consolidation|in|the|right|lower|lobe|and|right|middle|lobe|have|decreased|.|impression|:|1|.|persistent|very|extensive|consolidation|in|the|right|upper|lobe|(|with|normal|patent|airways|)|.|the|degree|and|extent|of|right|upper|lobe|consolidation|have|definitely|decreased|from|the|previous|study|of|*|*|date|[|oct|04|2007|]|consistent|with|resolving|pneumonia|.|there|are|no|findings|to|indicate|endobronchial|obstructing|lesions|.|2|.|interval|decrease|in|areas|of|airspace|consolidation|and|right|lower|lobe|and|right|middle|lobe|.|3|.|near|complete|resolution|of|areas|of|consolidation|in|left|upper|lobe|and|left|lower|lobe|.|4|.|resolved|left|pleural|effusion|.|my|signature|below|is|attestation|that|i|have|interpreted|this|/|these|examination|(|s|)|and|agree|with|the|findings|as|noted|above|.|end|of|impression|:',
            'note' : '[Report de-identified (Safe-harbor compliant) by De-ID v.6.22.07.0]\\n\\n\\nEXAMINATION PERFORMED:\\nCT THORAX  WITHOUT CONTRAST   **DATE[Nov 02 07]     0944 HOURS\\n\\nCLINICAL HISTORY:   \\nMultilobar pneumonia. Evaluation for response.\\n\\nCOMPARISON:   \\nPrevious chest CT scan from **DATE[Oct 04 2007].\\n\\nTECHNIQUE:   \\nHelical CT imaging of the chest was obtained without intravenous\\nor oral contrast with contiguous 5.0mm thick axial reconstructions\\nusing both lung and standard reconstruction algorithms.\\n\\nFINDINGS:   \\nThe areas of patchy airspace consolidation in the left upper lobe\\nhave resolved. There has been near complete resolution of the left\\nlower lobe pneumonia. The left pleural effusion has resolved.\\n\\nThere is persistent extensive dense consolidation in the right\\nupper lobe which has decreased. The areas of airspace\\nconsolidation in the right lower lobe and right middle lobe have\\ndecreased.\\n\\nIMPRESSION:   \\n1. PERSISTENT VERY EXTENSIVE CONSOLIDATION IN THE RIGHT UPPER LOBE\\n(WITH NORMAL PATENT AIRWAYS). THE DEGREE AND EXTENT OF RIGHT UPPER\\nLOBE CONSOLIDATION HAVE DEFINITELY DECREASED FROM THE PREVIOUS\\nSTUDY OF **DATE[Oct 04 2007] CONSISTENT WITH RESOLVING PNEUMONIA. THERE ARE\\nNO FINDINGS TO INDICATE ENDOBRONCHIAL OBSTRUCTING LESIONS.\\n2. INTERVAL DECREASE IN AREAS OF AIRSPACE CONSOLIDATION AND RIGHT\\nLOWER LOBE AND RIGHT MIDDLE LOBE.\\n3. NEAR COMPLETE RESOLUTION OF AREAS OF CONSOLIDATION IN LEFT\\nUPPER LOBE AND LEFT LOWER LOBE.\\n4. RESOLVED LEFT PLEURAL EFFUSION.\\n\\nMy signature below is attestation that I have interpreted\\nthis/these examination(s) and agree with the findings as noted\\nabove.\\n\\nEND OF IMPRESSION:\\n\\n\\n\\n\\n\n',
        }
    }

    return jsonify(patients)

if __name__ == '__main__':
    app.run(host='0.0.0.0', debug=True)